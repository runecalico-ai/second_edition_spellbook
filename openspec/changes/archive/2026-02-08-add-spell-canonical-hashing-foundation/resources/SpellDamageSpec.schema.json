{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://example.com/schemas/SpellDamageSpec.schema.json",
    "title": "SpellDamageSpec",
    "type": "object",
    "additionalProperties": false,
    "required": [
        "kind"
    ],
    "properties": {
        "kind": {
            "type": "string",
            "enum": [
                "none",
                "modeled",
                "dm_adjudicated"
            ]
        },
        "combine_mode": {
            "type": "string",
            "enum": [
                "sum",
                "max",
                "choose_one",
                "sequence"
            ],
            "default": "sum"
        },
        "parts": {
            "type": "array",
            "minItems": 1,
            "items": {
                "$ref": "#/$defs/DamagePart"
            }
        },
        "dm_guidance": {
            "type": "string",
            "maxLength": 2048
        },
        "notes": {
            "type": "string",
            "maxLength": 2048
        }
    },
    "allOf": [
        {
            "if": {
                "properties": {
                    "kind": {
                        "const": "none"
                    }
                }
            },
            "then": {
                "not": {
                    "required": [
                        "parts"
                    ]
                }
            }
        },
        {
            "if": {
                "properties": {
                    "kind": {
                        "const": "modeled"
                    }
                }
            },
            "then": {
                "required": [
                    "parts"
                ]
            }
        },
        {
            "if": {
                "properties": {
                    "kind": {
                        "const": "dm_adjudicated"
                    }
                }
            },
            "then": {
                "required": [
                    "dm_guidance"
                ]
            }
        }
    ],
    "$defs": {
        "DamagePart": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "id",
                "damage_type",
                "base",
                "application",
                "save"
            ],
            "properties": {
                "id": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9_]{0,31}$"
                },
                "label": {
                    "type": "string",
                    "maxLength": 80
                },
                "damage_type": {
                    "type": "string",
                    "enum": [
                        "acid",
                        "cold",
                        "electricity",
                        "fire",
                        "sonic",
                        "force",
                        "magic",
                        "negative_energy",
                        "positive_energy",
                        "poison",
                        "psychic",
                        "physical_bludgeoning",
                        "physical_piercing",
                        "physical_slashing",
                        "untyped",
                        "special"
                    ]
                },
                "base": {
                    "$ref": "#/$defs/DicePool"
                },
                "scaling": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/ScalingRule"
                    }
                },
                "clamp_total": {
                    "$ref": "#/$defs/ClampSpec"
                },
                "application": {
                    "$ref": "#/$defs/ApplicationSpec"
                },
                "save": {
                    "$ref": "#/$defs/SaveSpec"
                },
                "mr_interaction": {
                    "type": "string",
                    "enum": [
                        "normal",
                        "ignores_mr",
                        "special",
                        "unknown"
                    ],
                    "default": "normal"
                },
                "notes": {
                    "type": "string",
                    "maxLength": 1024
                }
            }
        },
        "DicePool": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "terms"
            ],
            "properties": {
                "terms": {
                    "type": "array",
                    "minItems": 1,
                    "items": {
                        "$ref": "#/$defs/DiceTerm"
                    },
                    "description": "Multiple dice terms allow things like (2d4 + 1d6 + 3)."
                },
                "flat_modifier": {
                    "type": "integer",
                    "minimum": -100000,
                    "maximum": 100000,
                    "default": 0,
                    "description": "Applies after summing terms."
                }
            }
        },
        "DiceTerm": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "count",
                "sides"
            ],
            "properties": {
                "count": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 1000
                },
                "sides": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 1000
                },
                "per_die_modifier": {
                    "type": "integer",
                    "minimum": -100000,
                    "maximum": 100000,
                    "default": 0,
                    "description": "Rare but supports formats like (XdY+Z per die) if you ever need it."
                }
            }
        },
        "ScalingRule": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "kind",
                "driver"
            ],
            "properties": {
                "kind": {
                    "type": "string",
                    "enum": [
                        "add_dice_per_step",
                        "add_flat_per_step",
                        "set_base_by_level_band"
                    ]
                },
                "driver": {
                    "type": "string",
                    "enum": [
                        "caster_level",
                        "spell_level",
                        "target_hd",
                        "target_level",
                        "choice",
                        "other"
                    ]
                },
                "step": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 1,
                    "description": "One increment per N of driver."
                },
                "max_steps": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Cap increments. Common: +1d6/level max 10 dice => max_steps=10 with base=0."
                },
                "dice_increment": {
                    "$ref": "#/$defs/DiceTerm"
                },
                "flat_increment": {
                    "type": "integer",
                    "minimum": -100000,
                    "maximum": 100000
                },
                "level_bands": {
                    "type": "array",
                    "minItems": 1,
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "required": [
                            "min",
                            "max",
                            "base"
                        ],
                        "properties": {
                            "min": {
                                "type": "integer",
                                "minimum": 1,
                                "maximum": 60
                            },
                            "max": {
                                "type": "integer",
                                "minimum": 1,
                                "maximum": 60
                            },
                            "base": {
                                "$ref": "#/$defs/DicePool"
                            }
                        }
                    },
                    "description": "If kind=set_base_by_level_band: select band by caster_level (or other driver by convention)."
                },
                "notes": {
                    "type": "string",
                    "maxLength": 512
                }
            },
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "kind": {
                                "const": "add_dice_per_step"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "dice_increment"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "kind": {
                                "const": "add_flat_per_step"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "flat_increment"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "kind": {
                                "const": "set_base_by_level_band"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "level_bands"
                        ]
                    }
                }
            ]
        },
        "ClampSpec": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
                "min_total": {
                    "type": "integer",
                    "minimum": -100000,
                    "maximum": 100000
                },
                "max_total": {
                    "type": "integer",
                    "minimum": -100000,
                    "maximum": 100000
                }
            }
        },
        "ApplicationSpec": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "scope"
            ],
            "properties": {
                "scope": {
                    "type": "string",
                    "enum": [
                        "per_target",
                        "per_area_target",
                        "per_missile",
                        "per_ray",
                        "per_round",
                        "per_turn",
                        "per_hit",
                        "special"
                    ]
                },
                "ticks": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 10000,
                    "default": 1,
                    "description": "Number of applications of THIS part."
                },
                "tick_driver": {
                    "type": "string",
                    "enum": [
                        "fixed",
                        "caster_level",
                        "spell_level",
                        "duration",
                        "choice",
                        "dm"
                    ],
                    "default": "fixed"
                },
                "notes": {
                    "type": "string",
                    "maxLength": 512
                }
            }
        },
        "SaveSpec": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "kind"
            ],
            "properties": {
                "kind": {
                    "type": "string",
                    "enum": [
                        "none",
                        "half",
                        "negates",
                        "partial",
                        "special"
                    ]
                },
                "partial": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": [
                        "numerator",
                        "denominator"
                    ],
                    "properties": {
                        "numerator": {
                            "type": "integer",
                            "minimum": 0,
                            "maximum": 1000
                        },
                        "denominator": {
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 1000
                        }
                    },
                    "description": "Use exact rationals for determinism (e.g., 1/2, 1/4)."
                },
                "notes": {
                    "type": "string",
                    "maxLength": 512
                }
            },
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "kind": {
                                "const": "partial"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "partial"
                        ]
                    }
                }
            ]
        }
    }
}